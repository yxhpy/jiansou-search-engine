<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简搜 - 简洁高效的搜索工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'huawei-blue': '#007DFF',
                        'huawei-gray': '#F5F5F5',
                        'huawei-dark': '#1A1A1A',
                        'huawei-text': '#333333',
                        'huawei-light': '#FAFAFA',
                    },
                    fontFamily: {
                        'huawei': ['SF Pro Display', 'PingFang SC', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                    boxShadow: {
                        'huawei': '0 2px 12px rgba(0, 0, 0, 0.08)',
                        'huawei-hover': '0 4px 20px rgba(0, 125, 255, 0.15)',
                    }
                }
            }
        }
    </script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'SF Pro Display', 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .search-container {
            position: relative;
            transition: all 0.2s ease;
        }
        
        .search-container:focus-within {
            transform: translateY(-2px);
        }
        
        .search-input {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
        }
        
        .search-input:focus {
            border-color: #007DFF;
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 125, 255, 0.1);
        }
        
        .search-button {
            background: #007DFF;
            transition: all 0.2s ease;
            border: none;
            outline: none;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 125, 255, 0.2);
        }
        
        .search-button:hover {
            background: #0056CC;
            box-shadow: 0 4px 12px rgba(0, 125, 255, 0.3);
        }
        
        .search-button:active {
            background: #004499;
            box-shadow: 0 2px 4px rgba(0, 125, 255, 0.2);
        }
        
        .search-button:focus {
            outline: 2px solid rgba(0, 125, 255, 0.5);
            outline-offset: 2px;
        }
        
        .search-button i {
            transition: transform 0.2s ease;
        }
        
        .search-button:hover i {
            transform: scale(1.1);
        }
        
        .quick-link-item {
            transition: all 0.2s ease;
        }
        
        .quick-link-item:hover {
            transform: translateY(-4px);
        }
        
        .nav-link {
            color: #666;
            transition: color 0.2s ease;
        }
        
        .nav-link:hover {
            color: #007DFF;
        }
        
        .modal-backdrop {
            backdrop-filter: blur(20px);
            background: rgba(0, 0, 0, 0.3);
        }
        
        .category-tag {
            background: rgba(0, 125, 255, 0.08);
            color: #007DFF;
            border: 1px solid rgba(0, 125, 255, 0.2);
            transition: all 0.2s ease;
        }
        
        .category-tag:hover {
            background: rgba(0, 125, 255, 0.15);
            border-color: #007DFF;
        }

        /* 移动端优化 */
        @media (max-width: 768px) {
            .search-container:focus-within {
                transform: none;
            }
            
            .quick-link-item:hover {
                transform: none;
            }

            /* 确保模态框在移动端正确显示 */
            .modal-content {
                max-height: 90vh;
                overflow-y: auto;
            }
        }

        /* 移动端搜索框优化 */
        @media (max-width: 640px) {
            .search-engine-select {
                min-width: 80px !important;
            }
        }
    </style>
</head>
<body class="bg-white min-h-screen font-huawei">
    <!-- 顶部导航 -->
    <nav class="w-full py-4 md:py-6 px-4 md:px-8">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="text-lg font-medium text-huawei-dark">简搜</div>
            <div class="hidden sm:flex space-x-8">
                <a href="#" class="nav-link text-sm">关于</a>
                <a href="#" class="nav-link text-sm">帮助</a>
            </div>
            <!-- 移动端菜单按钮 -->
            <button class="sm:hidden text-gray-600 hover:text-huawei-blue" onclick="toggleMobileMenu()">
                <i class="fas fa-bars text-lg"></i>
            </button>
        </div>
        <!-- 移动端菜单 -->
        <div id="mobile-menu" class="hidden sm:hidden mt-4 pt-4 border-t border-gray-100">
            <div class="flex flex-col space-y-2">
                <a href="#" class="nav-link text-sm py-2">关于</a>
                <a href="#" class="nav-link text-sm py-2">帮助</a>
            </div>
        </div>
    </nav>

    <!-- 主搜索区域 -->
    <div class="flex-grow flex flex-col items-center justify-center px-4 md:px-8 pt-8 md:pt-20 pb-8 md:pb-12">
        <!-- 搜索标题 -->
        <div class="text-center mb-8 md:mb-16">
            <h1 class="text-3xl md:text-5xl font-light text-huawei-dark mb-2 md:mb-4 tracking-wide">简搜</h1>
            <p class="text-sm md:text-base text-gray-500 font-light">简洁高效的搜索体验</p>
        </div>
        
        <!-- 搜索框 -->
        <div class="w-full max-w-2xl mx-auto mb-8 md:mb-16">
            <form id="search-form" onsubmit="return handleSubmitSearch(event);">
                <div class="search-container relative">
                    <!-- 移动端优化：垂直堆叠搜索引擎选择器和搜索框 -->
                    <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
                        <!-- 搜索引擎选择器 -->
                        <div class="relative w-full sm:w-auto">
                            <select id="search-engine-select" class="search-engine-select appearance-none w-full sm:min-w-[120px] bg-white border border-gray-200 rounded-lg py-3 md:py-4 px-3 md:px-4 pr-10 text-sm md:text-base text-huawei-text focus:outline-none focus:border-huawei-blue">
                                <!-- 搜索引擎选项将通过JavaScript动态生成 -->
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400 text-sm"></i>
                            </div>
                        </div>
                        
                        <div class="flex-1 relative">
                            <input 
                                type="text" 
                                id="search-input"
                                class="search-input w-full py-3 md:py-4 px-4 md:px-6 pr-16 md:pr-20 rounded-xl border text-sm md:text-base text-huawei-text placeholder-gray-400 focus:outline-none"
                                placeholder="输入关键词进行搜索"
                                autofocus
                            >
                            <button 
                                type="submit" 
                                class="search-button absolute right-2 top-1/2 -translate-y-1/2 text-white w-10 md:w-12 h-8 md:h-10 rounded-lg"
                                aria-label="搜索"
                            >
                                <i class="fas fa-search text-sm md:text-base"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- 快速链接区域 -->
        <div class="w-full max-w-5xl mx-auto">
            <!-- 控制栏 -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 md:mb-8 gap-4">
                <h2 class="text-base md:text-lg font-medium text-huawei-text">快速访问</h2>
                <div class="flex flex-wrap items-center gap-2 sm:gap-4 w-full sm:w-auto">
                    <select id="category-filter" class="px-3 py-2 bg-white border border-gray-200 rounded-lg text-xs md:text-sm focus:outline-none focus:border-huawei-blue flex-1 sm:flex-none">
                        <option value="all">全部</option>
                    </select>
                    <div class="flex gap-2">
                        <button id="add-link-btn" class="inline-flex items-center px-3 py-2 bg-huawei-blue text-white rounded-lg text-xs md:text-sm hover:bg-blue-600 transition-colors">
                            <i class="fas fa-plus mr-1 md:mr-2 text-xs"></i><span class="hidden sm:inline">添加</span>
                        </button>
                        <button id="manage-engines-btn" class="inline-flex items-center px-3 py-2 bg-purple-500 text-white rounded-lg text-xs md:text-sm hover:bg-purple-600 transition-colors">
                            <i class="fas fa-cog mr-1 md:mr-2 text-xs"></i><span class="hidden sm:inline">搜索引擎</span>
                        </button>
                        <button id="edit-mode-btn" class="inline-flex items-center px-3 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs md:text-sm hover:bg-gray-200 transition-colors">
                            <i class="fas fa-edit mr-1 md:mr-2 text-xs"></i><span class="hidden sm:inline">管理</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 链接网格 -->
            <div id="quick-links-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-3 md:gap-4">
                <!-- 链接项目将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>
    
    <!-- 添加/编辑链接模态框 -->
    <div id="link-modal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-2xl w-full max-w-md shadow-2xl max-h-[90vh] overflow-y-auto">
            <!-- 模态框头部 -->
            <div class="flex items-center justify-between p-4 md:p-6 border-b border-gray-100">
                <h3 id="modal-title" class="text-base md:text-lg font-medium text-huawei-text">添加链接</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600 p-1">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- 表单内容 -->
            <form id="link-form" class="p-4 md:p-6 space-y-4 md:space-y-5">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">名称</label>
                    <input type="text" id="link-name" class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-huawei-blue text-sm md:text-base" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">网址</label>
                    <input type="url" id="link-url" class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-huawei-blue text-sm md:text-base" required>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">图标</label>
                        <input type="text" id="link-icon" class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-huawei-blue text-sm md:text-base" placeholder="fas fa-globe">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">分类</label>
                        <select id="link-category" class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-huawei-blue text-sm md:text-base">
                            <!-- 分类选项通过JavaScript生成 -->
                        </select>
                    </div>
                </div>
                
                <!-- 操作按钮 -->
                <div class="flex flex-col sm:flex-row gap-3 pt-4">
                    <button type="submit" class="flex-1 bg-huawei-blue text-white py-2 md:py-3 rounded-lg hover:bg-blue-600 transition-colors font-medium text-sm md:text-base">
                        保存
                    </button>
                    <button type="button" id="cancel-modal" class="flex-1 bg-gray-100 text-gray-600 py-2 md:py-3 rounded-lg hover:bg-gray-200 transition-colors font-medium text-sm md:text-base">
                        取消
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 搜索引擎管理模态框 -->
    <div id="engines-modal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-2xl w-full max-w-4xl shadow-2xl max-h-[90vh] overflow-hidden">
            <!-- 模态框头部 -->
            <div class="flex items-center justify-between p-4 md:p-6 border-b border-gray-100">
                <h3 class="text-base md:text-lg font-medium text-huawei-text">搜索引擎管理</h3>
                <button id="close-engines-modal" class="text-gray-400 hover:text-gray-600 p-1">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- 内容区域 -->
            <div class="p-4 md:p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                <!-- 添加新搜索引擎按钮 -->
                <div class="mb-6">
                    <button id="add-engine-btn" class="inline-flex items-center px-3 md:px-4 py-2 bg-huawei-blue text-white rounded-lg text-xs md:text-sm hover:bg-blue-600 transition-colors">
                        <i class="fas fa-plus mr-1 md:mr-2 text-xs"></i>添加搜索引擎
                    </button>
                </div>
                
                <!-- 搜索引擎列表 -->
                <div class="space-y-4" id="search-engines-list">
                    <!-- 搜索引擎项目将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 添加/编辑搜索引擎模态框 -->
    <div id="engine-form-modal" class="fixed inset-0 modal-backdrop z-[70] hidden flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-2xl w-full max-w-md shadow-2xl max-h-[90vh] overflow-y-auto">
            <!-- 模态框头部 -->
            <div class="flex items-center justify-between p-4 md:p-6 border-b border-gray-100">
                <h3 id="engine-modal-title" class="text-base md:text-lg font-medium text-huawei-text">添加搜索引擎</h3>
                <button id="close-engine-form-modal" class="text-gray-400 hover:text-gray-600 p-1">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- 表单内容 -->
            <form id="engine-form" class="p-4 md:p-6 space-y-4 md:space-y-5">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">名称标识</label>
                    <input type="text" id="engine-name" class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-huawei-blue text-sm md:text-base" placeholder="baidu" required>
                    <p class="text-xs text-gray-500 mt-1">用于内部标识，建议使用英文</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">显示名称</label>
                    <input type="text" id="engine-display-name" class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-huawei-blue text-sm md:text-base" placeholder="百度" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">搜索网址模板</label>
                    <input type="url" id="engine-url-template" class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-huawei-blue text-sm md:text-base" placeholder="https://www.baidu.com/s?wd={query}" required>
                    <p class="text-xs text-gray-500 mt-1">使用 {query} 作为搜索关键词的占位符</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">图标</label>
                        <input type="text" id="engine-icon" class="w-full px-3 md:px-4 py-2 md:py-3 border border-gray-200 rounded-lg focus:outline-none focus:border-huawei-blue text-sm md:text-base" placeholder="fas fa-search">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">颜色</label>
                        <input type="color" id="engine-color" class="w-full h-10 md:h-12 border border-gray-200 rounded-lg focus:outline-none focus:border-huawei-blue" value="#007DFF">
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="engine-is-active" checked class="w-4 h-4 text-huawei-blue border-gray-300 rounded focus:ring-huawei-blue">
                        <span class="text-sm text-gray-700">启用</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="engine-is-default" class="w-4 h-4 text-huawei-blue border-gray-300 rounded focus:ring-huawei-blue">
                        <span class="text-sm text-gray-700">设为默认</span>
                    </label>
                </div>
                
                <!-- 操作按钮 -->
                <div class="flex flex-col sm:flex-row gap-3 pt-4">
                    <button type="submit" class="flex-1 bg-huawei-blue text-white py-2 md:py-3 rounded-lg hover:bg-blue-600 transition-colors font-medium text-sm md:text-base">
                        保存
                    </button>
                    <button type="button" id="cancel-engine-modal" class="flex-1 bg-gray-100 text-gray-600 py-2 md:py-3 rounded-lg hover:bg-gray-200 transition-colors font-medium text-sm md:text-base">
                        取消
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 全局变量
        let quickLinksData = { quickLinks: [], categories: [] };
        let searchEnginesData = [];
        let currentSearchEngine = 'baidu';
        let editMode = false;
        let currentEditId = null;
        let currentEditEngineId = null;

        // 移动端菜单切换
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('search-input');
            const searchButton = document.querySelector('.search-button');
            const searchContainer = document.querySelector('.search-container');
            
            // 搜索框交互（移动端优化）
            searchInput.addEventListener('focus', function() {
                if (window.innerWidth > 768) {
                    searchContainer.style.transform = 'translateY(-2px)';
                }
            });
            
            searchInput.addEventListener('blur', function() {
                if (window.innerWidth > 768) {
                    searchContainer.style.transform = 'translateY(0)';
                }
            });

            // 键盘事件
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSubmitSearch(e);
                }
            });

            // 搜索按钮点击反馈
            searchButton.addEventListener('mousedown', function() {
                this.style.background = '#004499';
            });

            searchButton.addEventListener('mouseup', function() {
                this.style.background = '#0056CC';
            });

            searchButton.addEventListener('mouseleave', function() {
                this.style.background = '#007DFF';
            });

            // 输入框内容变化时的视觉反馈
            searchInput.addEventListener('input', function() {
                if (this.value.trim()) {
                    searchButton.style.background = '#007DFF';
                    searchButton.style.boxShadow = '0 4px 12px rgba(0, 125, 255, 0.3)';
                } else {
                    searchButton.style.background = '#007DFF';
                    searchButton.style.boxShadow = '0 2px 8px rgba(0, 125, 255, 0.2)';
                }
            });

            // 初始化快速链接
            initQuickLinks();
            // 初始化搜索引擎
            initSearchEngines();
        });

        // 处理搜索表单提交
        async function handleSubmitSearch(e) {
            if (e) e.preventDefault(); // 阻止表单默认提交行为
            
            const query = document.getElementById('search-input').value.trim();
            if (!query) return false;

            const selectedEngine = document.getElementById('search-engine-select').value;

            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        search_engine: selectedEngine
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    window.open(result.search_url, '_blank');
                } else {
                    // 降级处理
                    window.open(`https://www.baidu.com/s?wd=${encodeURIComponent(query)}`, '_blank');
                }
            } catch (error) {
                console.error('搜索失败:', error);
                // 降级处理
                window.open(`https://www.baidu.com/s?wd=${encodeURIComponent(query)}`, '_blank');
            }

            // 保持搜索框内容，不清空
            return false;
        }

        // 初始化快速链接功能
        async function initQuickLinks() {
            try {
                await loadQuickLinksData();
                await loadCategories();
                setupEventListeners();
                renderQuickLinks();
                renderCategories();
            } catch (error) {
                console.error('初始化失败:', error);
                showError('数据加载失败，请刷新页面重试');
            }
        }

        // 从API加载快速链接数据
        async function loadQuickLinksData() {
            try {
                const response = await fetch('/api/quick-links');
                if (!response.ok) throw new Error('无法加载快速链接数据');
                quickLinksData.quickLinks = await response.json();
            } catch (error) {
                console.error('加载快速链接失败:', error);
                throw error;
            }
        }

        // 从API加载分类数据
        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                if (!response.ok) throw new Error('无法加载分类数据');
                quickLinksData.categories = await response.json();
            } catch (error) {
                console.error('加载分类失败:', error);
                quickLinksData.categories = ['搜索', '社交', '工具', '娱乐', '购物', '新闻'];
            }
        }

        // 设置事件监听
        function setupEventListeners() {
            document.getElementById('add-link-btn').addEventListener('click', () => {
                currentEditId = null;
                document.getElementById('modal-title').textContent = '添加链接';
                clearForm();
                showModal();
            });

            document.getElementById('edit-mode-btn').addEventListener('click', toggleEditMode);
            document.getElementById('category-filter').addEventListener('change', (e) => {
                renderQuickLinks(e.target.value);
            });

            // 模态框事件
            document.getElementById('close-modal').addEventListener('click', hideModal);
            document.getElementById('cancel-modal').addEventListener('click', hideModal);
            document.getElementById('link-form').addEventListener('submit', handleFormSubmit);
            
            // 修复背景点击关闭模态框
            document.getElementById('link-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('link-modal')) {
                    hideModal();
                }
            });
        }

        // 渲染快速链接
        function renderQuickLinks(filterCategory = 'all') {
            const container = document.getElementById('quick-links-container');
            const filteredLinks = filterCategory === 'all' 
                ? quickLinksData.quickLinks 
                : quickLinksData.quickLinks.filter(link => link.category === filterCategory);

            container.innerHTML = filteredLinks.map(link => `
                <div class="quick-link-item group relative" data-id="${link.id}">
                    <a href="${link.url}" target="_blank" class="block p-3 md:p-4 bg-white border border-gray-100 rounded-xl hover:shadow-huawei-hover transition-all duration-200">
                        <div class="w-10 h-10 md:w-12 md:h-12 rounded-xl flex items-center justify-center mb-2 md:mb-3 mx-auto" style="background: ${link.color || '#007DFF'}20; color: ${link.color || '#007DFF'}">
                            <i class="${link.icon || 'fas fa-globe'} text-base md:text-lg"></i>
                        </div>
                        <p class="text-xs md:text-sm text-huawei-text text-center font-medium truncate leading-tight">${link.name}</p>
                        <p class="text-xs text-gray-500 text-center mt-1 truncate">${link.category}</p>
                    </a>
                    ${editMode ? `
                        <div class="absolute top-1 md:top-2 right-1 md:right-2 flex space-x-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="event.stopPropagation(); editLink(${link.id})" class="w-6 md:w-7 h-6 md:h-7 bg-huawei-blue text-white rounded-lg text-xs hover:bg-blue-600">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="event.stopPropagation(); deleteLink(${link.id})" class="w-6 md:w-7 h-6 md:h-7 bg-red-500 text-white rounded-lg text-xs hover:bg-red-600">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // 渲染分类
        function renderCategories() {
            const categoryFilter = document.getElementById('category-filter');
            const linkCategory = document.getElementById('link-category');

            categoryFilter.innerHTML = '<option value="all">全部</option>' +
                quickLinksData.categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');

            if (linkCategory) {
                linkCategory.innerHTML = quickLinksData.categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            }
        }

        // 切换编辑模式
        function toggleEditMode() {
            editMode = !editMode;
            const btn = document.getElementById('edit-mode-btn');
            
            if (editMode) {
                btn.innerHTML = '<i class="fas fa-check mr-2 text-xs"></i>完成';
                btn.className = 'inline-flex items-center px-4 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600 transition-colors';
            } else {
                btn.innerHTML = '<i class="fas fa-edit mr-2 text-xs"></i>管理';
                btn.className = 'inline-flex items-center px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm hover:bg-gray-200 transition-colors';
            }
            
            renderQuickLinks();
        }

        // 编辑链接
        function editLink(id) {
            const link = quickLinksData.quickLinks.find(l => l.id === id);
            if (!link) return;

            currentEditId = id;
            document.getElementById('modal-title').textContent = '编辑链接';
            
            document.getElementById('link-name').value = link.name;
            document.getElementById('link-url').value = link.url;
            document.getElementById('link-icon').value = link.icon;
            document.getElementById('link-category').value = link.category;
            
            showModal();
        }

        // 删除链接
        async function deleteLink(id) {
            if (!confirm('确定删除此链接？')) return;

            try {
                const response = await fetch(`/api/quick-links/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadQuickLinksData();
                    renderQuickLinks();
                    showSuccess('删除成功');
                } else {
                    const error = await response.json();
                    showError(error.detail || '删除失败');
                }
            } catch (error) {
                console.error('删除失败:', error);
                showError('删除失败，请重试');
            }
        }

        // 模态框控制
        function showModal() {
            document.getElementById('link-modal').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('link-modal').classList.add('hidden');
            clearForm();
        }

        function clearForm() {
            document.getElementById('link-form').reset();
        }

        // 表单提交
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('link-name').value.trim(),
                url: document.getElementById('link-url').value.trim(),
                icon: document.getElementById('link-icon').value.trim() || 'fas fa-globe',
                category: document.getElementById('link-category').value,
                color: '#007DFF'
            };

            if (!formData.name || !formData.url) {
                showError('请填写名称和链接');
                return;
            }

            try {
                let response;
                if (currentEditId) {
                    // 更新链接
                    response = await fetch(`/api/quick-links/${currentEditId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                } else {
                    // 创建新链接
                    response = await fetch('/api/quick-links', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                }

                if (response.ok) {
                    await loadQuickLinksData();
                    await loadCategories();
                    renderQuickLinks();
                    renderCategories();
                    hideModal();
                    showSuccess(currentEditId ? '更新成功' : '添加成功');
                } else {
                    const error = await response.json();
                    showError(error.detail || '操作失败');
                }
            } catch (error) {
                console.error('操作失败:', error);
                showError('操作失败，请重试');
            }
        }

        // 显示成功消息
        function showSuccess(message) {
            showMessage(message, 'success');
        }

        // 显示错误消息
        function showError(message) {
            showMessage(message, 'error');
        }

        // 显示消息
        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            }`;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // ===== 搜索引擎管理功能 =====

        // 初始化搜索引擎功能
        async function initSearchEngines() {
            try {
                await loadSearchEngines();
                setupSearchEngineEventListeners();
                renderSearchEngineSelect();
            } catch (error) {
                console.error('搜索引擎初始化失败:', error);
                showError('搜索引擎数据加载失败');
            }
        }

        // 加载搜索引擎数据
        async function loadSearchEngines() {
            try {
                const response = await fetch('/api/search-engines');
                if (!response.ok) throw new Error('无法加载搜索引擎数据');
                searchEnginesData = await response.json();
                
                // 设置默认搜索引擎
                const defaultEngine = searchEnginesData.find(engine => engine.is_default);
                if (defaultEngine) {
                    currentSearchEngine = defaultEngine.name;
                }
            } catch (error) {
                console.error('加载搜索引擎失败:', error);
                throw error;
            }
        }

        // 渲染搜索引擎选择器
        function renderSearchEngineSelect() {
            const select = document.getElementById('search-engine-select');
            if (!select) return;
            
            select.innerHTML = searchEnginesData.map(engine => `
                <option value="${engine.name}" ${engine.name === currentSearchEngine ? 'selected' : ''}>
                    ${engine.display_name}
                </option>
            `).join('');
        }

        // 渲染搜索引擎列表
        function renderSearchEnginesList() {
            const container = document.getElementById('search-engines-list');
            if (!container) return;
            
            container.innerHTML = searchEnginesData.map(engine => `
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-4 bg-gray-50 rounded-lg border ${engine.is_default ? 'border-huawei-blue bg-blue-50' : 'border-gray-200'} gap-4">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0" style="background: ${engine.color}20; color: ${engine.color}">
                            <i class="${engine.icon} text-lg"></i>
                        </div>
                        <div class="min-w-0 flex-1">
                            <h4 class="font-medium text-gray-900 truncate">${engine.display_name}</h4>
                            <p class="text-sm text-gray-500 truncate">${engine.url_template}</p>
                            <div class="flex items-center space-x-2 sm:space-x-3 mt-1 flex-wrap">
                                ${engine.is_default ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-huawei-blue text-white">默认</span>' : ''}
                                ${engine.is_active ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">启用</span>' : '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">禁用</span>'}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-end gap-2 flex-wrap">
                        <button onclick="editSearchEngine(${engine.id})" class="inline-flex items-center px-2 sm:px-3 py-1.5 bg-blue-500 text-white rounded text-xs sm:text-sm hover:bg-blue-600 transition-colors">
                            <i class="fas fa-edit mr-1 text-xs"></i><span class="hidden sm:inline">编辑</span>
                        </button>
                        ${!engine.is_default ? `
                            <button onclick="setDefaultEngine(${engine.id})" class="inline-flex items-center px-2 sm:px-3 py-1.5 bg-green-500 text-white rounded text-xs sm:text-sm hover:bg-green-600 transition-colors">
                                <i class="fas fa-star mr-1 text-xs"></i><span class="hidden sm:inline">默认</span>
                            </button>
                        ` : ''}
                        <button onclick="deleteSearchEngine(${engine.id})" class="inline-flex items-center px-2 sm:px-3 py-1.5 bg-red-500 text-white rounded text-xs sm:text-sm hover:bg-red-600 transition-colors">
                            <i class="fas fa-trash mr-1 text-xs"></i><span class="hidden sm:inline">删除</span>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // 设置搜索引擎事件监听
        function setupSearchEngineEventListeners() {
            // 搜索引擎管理按钮
            document.getElementById('manage-engines-btn').addEventListener('click', () => {
                showEnginesModal();
            });

            // 添加搜索引擎按钮
            document.getElementById('add-engine-btn').addEventListener('click', () => {
                currentEditEngineId = null;
                document.getElementById('engine-modal-title').textContent = '添加搜索引擎';
                clearEngineForm();
                showEngineFormModal();
            });

            // 模态框关闭事件
            document.getElementById('close-engines-modal').addEventListener('click', hideEnginesModal);
            document.getElementById('close-engine-form-modal').addEventListener('click', hideEngineFormModal);
            document.getElementById('cancel-engine-modal').addEventListener('click', hideEngineFormModal);

            // 表单提交事件
            document.getElementById('engine-form').addEventListener('submit', handleEngineFormSubmit);

            // 模态框背景点击关闭
            document.getElementById('engines-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('engines-modal')) {
                    hideEnginesModal();
                }
            });
            document.getElementById('engine-form-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('engine-form-modal')) {
                    hideEngineFormModal();
                }
            });

            // 搜索引擎选择器变化事件
            document.getElementById('search-engine-select').addEventListener('change', (e) => {
                currentSearchEngine = e.target.value;
            });
        }

        // 显示搜索引擎管理模态框
        function showEnginesModal() {
            document.getElementById('engines-modal').classList.remove('hidden');
            renderSearchEnginesList();
        }

        // 隐藏搜索引擎管理模态框
        function hideEnginesModal() {
            document.getElementById('engines-modal').classList.add('hidden');
        }

        // 显示搜索引擎表单模态框
        function showEngineFormModal() {
            document.getElementById('engine-form-modal').classList.remove('hidden');
        }

        // 隐藏搜索引擎表单模态框
        function hideEngineFormModal() {
            document.getElementById('engine-form-modal').classList.add('hidden');
            clearEngineForm();
        }

        // 清空搜索引擎表单
        function clearEngineForm() {
            document.getElementById('engine-form').reset();
            document.getElementById('engine-color').value = '#007DFF';
            document.getElementById('engine-is-active').checked = true;
            document.getElementById('engine-is-default').checked = false;
            currentEditEngineId = null;
        }

        // 编辑搜索引擎
        function editSearchEngine(id) {
            const engine = searchEnginesData.find(e => e.id === id);
            if (!engine) return;

            currentEditEngineId = id;
            document.getElementById('engine-modal-title').textContent = '编辑搜索引擎';
            
            document.getElementById('engine-name').value = engine.name;
            document.getElementById('engine-display-name').value = engine.display_name;
            document.getElementById('engine-url-template').value = engine.url_template;
            document.getElementById('engine-icon').value = engine.icon;
            document.getElementById('engine-color').value = engine.color;
            document.getElementById('engine-is-active').checked = engine.is_active;
            document.getElementById('engine-is-default').checked = engine.is_default;
            
            // 编辑时禁用名称字段
            document.getElementById('engine-name').disabled = true;
            
            showEngineFormModal();
        }

        // 设置默认搜索引擎
        async function setDefaultEngine(id) {
            try {
                const response = await fetch(`/api/search-engines/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ is_default: true })
                });

                if (response.ok) {
                    await loadSearchEngines();
                    renderSearchEnginesList();
                    renderSearchEngineSelect();
                    showSuccess('已设置为默认搜索引擎');
                } else {
                    const error = await response.json();
                    showError(error.detail || '设置失败');
                }
            } catch (error) {
                console.error('设置默认搜索引擎失败:', error);
                showError('设置失败，请重试');
            }
        }

        // 删除搜索引擎
        async function deleteSearchEngine(id) {
            if (!confirm('确定删除此搜索引擎？')) return;

            try {
                const response = await fetch(`/api/search-engines/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadSearchEngines();
                    renderSearchEnginesList();
                    renderSearchEngineSelect();
                    showSuccess('删除成功');
                } else {
                    const error = await response.json();
                    showError(error.detail || '删除失败');
                }
            } catch (error) {
                console.error('删除搜索引擎失败:', error);
                showError('删除失败，请重试');
            }
        }

        // 搜索引擎表单提交
        async function handleEngineFormSubmit(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('engine-name').value.trim(),
                display_name: document.getElementById('engine-display-name').value.trim(),
                url_template: document.getElementById('engine-url-template').value.trim(),
                icon: document.getElementById('engine-icon').value.trim() || 'fas fa-search',
                color: document.getElementById('engine-color').value,
                is_active: document.getElementById('engine-is-active').checked,
                is_default: document.getElementById('engine-is-default').checked
            };

            // 验证表单
            if (!formData.name || !formData.display_name || !formData.url_template) {
                showError('请填写所有必填字段');
                return;
            }

            if (!formData.url_template.includes('{query}')) {
                showError('网址模板必须包含 {query} 占位符');
                return;
            }

            try {
                let response;
                if (currentEditEngineId) {
                    // 更新搜索引擎
                    const updateData = { ...formData };
                    delete updateData.name; // 不允许修改名称
                    
                    response = await fetch(`/api/search-engines/${currentEditEngineId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updateData)
                    });
                } else {
                    // 创建新搜索引擎
                    response = await fetch('/api/search-engines', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                }

                if (response.ok) {
                    await loadSearchEngines();
                    renderSearchEnginesList();
                    renderSearchEngineSelect();
                    hideEngineFormModal();
                    showSuccess(currentEditEngineId ? '更新成功' : '添加成功');
                } else {
                    const error = await response.json();
                    showError(error.detail || '操作失败');
                }
            } catch (error) {
                console.error('操作失败:', error);
                showError('操作失败，请重试');
            } finally {
                // 恢复名称字段
                document.getElementById('engine-name').disabled = false;
            }
        }
    </script>
</body>
</html> 